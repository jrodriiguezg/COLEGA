{% extends "base.html" %}

{% block content %}
<div class="explorer-container" style="display: flex; height: calc(100vh - 140px); gap: 20px;">
    <!-- File Tree -->
    <div class="card" style="width: 30%; display: flex; flex-direction: column;">
        <div class="card-header">
            <h3>Explorador</h3>
            <div class="breadcrumb" id="breadcrumb" style="font-size: 0.8em; color: var(--text-secondary);">/</div>
        </div>
        <div class="card-body" style="flex: 1; overflow-y: auto; padding: 0;">
            <ul id="file-list" class="file-list" style="list-style: none; padding: 0; margin: 0;">
                <!-- Files loaded here -->
            </ul>
        </div>
    </div>

    <!-- Editor -->
    <div class="card" style="flex: 1; display: flex; flex-direction: column;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="current-file-name">Sin archivo seleccionado</h3>
            <div>
                <button onclick="saveFile()" class="btn-primary" id="save-btn" disabled>Guardar</button>
            </div>
        </div>
        <div class="card-body" style="flex: 1; padding: 0;">
            <textarea id="file-editor"
                style="width: 100%; height: 100%; background: var(--bg-color); color: var(--text-color); border: none; padding: 10px; font-family: 'JetBrains Mono', monospace; resize: none;"
                disabled></textarea>
        </div>
    </div>
</div>

<style>
    .file-item {
        padding: 8px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-item:hover {
        background: var(--bg-color);
    }

    .file-item.active {
        background: var(--primary-color);
        color: white;
    }

    .file-icon {
        width: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentPath = '/';
    let currentFile = null;

    function loadDirectory(path) {
        fetch('/api/files/list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentPath = path;
                    updateBreadcrumb();
                    renderFileList(data.items);
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }

    function renderFileList(items) {
        const list = document.getElementById('file-list');
        list.innerHTML = '';

        // Add ".." if not root
        if (currentPath !== '/') {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.innerHTML = `<span class="file-icon">üìÅ</span> ..`;
            li.onclick = () => {
                const parent = currentPath.split('/').slice(0, -1).join('/') || '/';
                loadDirectory(parent);
            };
            list.appendChild(li);
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'file-item';
            const icon = item.is_dir ? 'üìÅ' : 'üìÑ';
            li.innerHTML = `<span class="file-icon">${icon}</span> ${item.name}`;

            li.onclick = () => {
                if (item.is_dir) {
                    const newPath = currentPath === '/' ? '/' + item.name : currentPath + '/' + item.name;
                    loadDirectory(newPath);
                } else {
                    loadFile(item.path);
                    // Highlight active
                    document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                }
            };
            list.appendChild(li);
        });
    }

    function updateBreadcrumb() {
        document.getElementById('breadcrumb').innerText = currentPath;
    }

    function loadFile(path) {
        fetch('/api/files/read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentFile = path;
                    document.getElementById('current-file-name').innerText = path.split('/').pop();
                    const editor = document.getElementById('file-editor');
                    editor.value = data.content;
                    editor.disabled = false;
                    document.getElementById('save-btn').disabled = false;
                } else {
                    alert('Error leyendo archivo: ' + data.message);
                }
            });
    }

    function saveFile() {
        if (!currentFile) return;
        const content = document.getElementById('file-editor').value;

        fetch('/api/files/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: currentFile, content: content })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Archivo guardado.');
                } else {
                    alert('Error guardando: ' + data.message);
                }
            });
    }

    // Initial load
    loadDirectory(currentPath);
</script>
{% endblock %}