{% extends "base.html" %}

{% block content %}
<div class="explorer-container">
    <!-- File Tree -->
    <div class="card file-tree-card">
        <div class="card-header pb-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="m-0">Explorador</h3>
                <span class="badge bg-secondary" id="item-count">0 items</span>
            </div>
            <input type="text" id="file-search" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Buscar archivo...">
            <div class="breadcrumb mt-2 text-muted text-truncate" id="breadcrumb">/</div>
        </div>
        <div class="card-body p-0 overflow-auto">
            <ul id="file-list" class="file-list m-0 p-0">
                <!-- Files loaded here -->
            </ul>
        </div>
    </div>

    <!-- Editor -->
    <div class="card editor-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 id="current-file-name" class="text-truncate m-0" style="max-width: 70%;">Sin archivo</h3>
            <button onclick="saveFile()" class="btn btn-primary btn-sm" id="save-btn" disabled>
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
        <div class="card-body p-0">
            <textarea id="file-editor" disabled></textarea>
        </div>
    </div>
</div>

<style>
    .explorer-container {
        display: flex;
        height: calc(100vh - 140px);
        gap: 20px;
    }
    
    .file-tree-card {
        width: 30%;
        display: flex;
        flex-direction: column;
        min-width: 250px;
    }
    
    .editor-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0; /* Fix flex overflow */
    }

    #file-editor {
        width: 100%;
        height: 100%;
        background: var(--bg-dark);
        color: #d4d4d4;
        border: none;
        padding: 15px;
        font-family: 'JetBrains Mono', monospace;
        resize: none;
        line-height: 1.5;
        outline: none;
    }

    .file-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.2s;
        font-size: 0.9rem;
    }

    .file-item:hover {
        background: rgba(255,255,255,0.05);
    }

    .file-item.active {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        border-left: 3px solid #3b82f6;
    }

    .file-icon {
        width: 20px;
        text-align: center;
        opacity: 0.7;
    }

    @media (max-width: 992px) {
        .explorer-container {
            flex-direction: column;
            height: auto;
        }
        .file-tree-card {
            width: 100%;
            height: 300px;
        }
        .editor-card {
            width: 100%;
            height: 500px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentPath = '/';
    let currentFile = null;
    let allItems = [];

    // Search functionality
    document.getElementById('file-search').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = allItems.filter(item => item.name.toLowerCase().includes(query));
        renderList(filtered);
    });

    function loadDirectory(path) {
        fetch('/api/files/list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentPath = path;
                    allItems = data.items; // Store for search
                    updateBreadcrumb();
                    document.getElementById('file-search').value = ''; // Reset search
                    renderFileList(data.items);
                } else {
                    alert('Error: ' + data.message);
                }
            });
    }

    function renderFileList(items) {
        // Just a wrapper to set allItems if called directly, basically handles ".." insertion
        renderList(items);
    }

    function renderList(items) {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        document.getElementById('item-count').innerText = `${items.length} items`;

        // Add ".." if not root and we are not filtering deeply (only show .. if showing full list logic? keeping it simple)
        const isSearching = document.getElementById('file-search').value.length > 0;
        
        if (currentPath !== '/' && !isSearching) {
            const li = document.createElement('li');
            li.className = 'file-item text-secondary';
            li.innerHTML = `<span class="file-icon"><i class="fas fa-level-up-alt"></i></span> ..`;
            li.onclick = () => {
                const parent = currentPath.split('/').slice(0, -1).join('/') || '/';
                loadDirectory(parent);
            };
            list.appendChild(li);
        }

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'file-item';
            const iconClass = item.is_dir ? 'fas fa-folder text-warning' : 'fas fa-file-code text-info';
            li.innerHTML = `<span class="file-icon"><i class="${iconClass}"></i></span> ${item.name}`;

            li.onclick = () => {
                if (item.is_dir) {
                    const newPath = currentPath === '/' ? '/' + item.name : currentPath + '/' + item.name;
                    loadDirectory(newPath);
                } else {
                    loadFile(item.path);
                    document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                }
            };
            list.appendChild(li);
        });
    }

    function updateBreadcrumb() {
        document.getElementById('breadcrumb').innerText = currentPath;
    }

    function loadFile(path) {
        fetch('/api/files/read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    currentFile = path;
                    document.getElementById('current-file-name').innerText = path.split('/').pop();
                    const editor = document.getElementById('file-editor');
                    editor.value = data.content;
                    editor.disabled = false;
                    document.getElementById('save-btn').disabled = false;
                } else {
                    alert('Error leyendo archivo: ' + data.message);
                }
            });
    }

    function saveFile() {
        if (!currentFile) return;
        const content = document.getElementById('file-editor').value;

        fetch('/api/files/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: currentFile, content: content })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Minimal feedback animation could go here
                    const btn = document.getElementById('save-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Guardado';
                    setTimeout(() => btn.innerHTML = originalText, 2000);
                } else {
                    alert('Error guardando: ' + data.message);
                }
            });
    }

    // Initial load
    loadDirectory(currentPath);
</script>
{% endblock %}