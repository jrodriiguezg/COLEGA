{% extends "base.html" %}

{% block content %}
<!-- System Status / DnD Grid -->
<div class="row g-4 mb-4" id="dashboard-grid">
    <!-- CPU Temp -->
    <div class="col-md-3" data-id="widget-cpu-temp">
        <div class="card h-100 border-primary border-opacity-25 shadow-sm widget-card">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                    <i class="fas fa-thermometer-half fa-2x text-primary"></i>
                </div>
                <div>
                    <h6 class="card-subtitle mb-1 text-muted">CPU Temp</h6>
                    <h2 class="card-title mb-0 fw-bold" id="cpu-temp">--</h2>
                </div>
                <div class="ms-auto text-muted move-handle" style="cursor: move;">
                    <i class="fas fa-grip-vertical"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- CPU Usage -->
    <div class="col-md-3" data-id="widget-cpu-usage">
        <div class="card h-100 border-info border-opacity-25 shadow-sm widget-card">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                    <i class="fas fa-microchip fa-2x text-info"></i>
                </div>
                <div>
                    <h6 class="card-subtitle mb-1 text-muted">CPU Usage</h6>
                    <h2 class="card-title mb-0 fw-bold" id="cpu-usage">--</h2>
                </div>
                <div class="ms-auto text-muted move-handle" style="cursor: move;">
                    <i class="fas fa-grip-vertical"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- RAM Usage -->
    <div class="col-md-3" data-id="widget-ram-usage">
        <div class="card h-100 border-warning border-opacity-25 shadow-sm widget-card">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                    <i class="fas fa-memory fa-2x text-warning"></i>
                </div>
                <div>
                    <h6 class="card-subtitle mb-1 text-muted">RAM Usage</h6>
                    <h2 class="card-title mb-0 fw-bold" id="ram-usage">--</h2>
                </div>
                <div class="ms-auto text-muted move-handle" style="cursor: move;">
                    <i class="fas fa-grip-vertical"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Disk Usage -->
    <div class="col-md-3" data-id="widget-disk-usage">
        <div class="card h-100 border-success border-opacity-25 shadow-sm widget-card">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                    <i class="fas fa-hdd fa-2x text-success"></i>
                </div>
                <div>
                    <h6 class="card-subtitle mb-1 text-muted">Disk Usage</h6>
                    <h2 class="card-title mb-0 fw-bold" id="disk-usage">--</h2>
                </div>
                <div class="ms-auto text-muted move-handle" style="cursor: move;">
                    <i class="fas fa-grip-vertical"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Microphone Control -->
    <div class="col-md-6">
        <div class="card h-100 transition-all" id="mic-card">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3 position-relative" id="mic-icon-bg">
                        <i class="fas fa-microphone-slash fa-2x text-danger" id="mic-icon"></i>
                        <span id="mic-pulse"
                            class="position-absolute top-50 start-50 translate-middle border border-primary rounded-circle"
                            style="width: 100%; height: 100%; opacity: 0; transition: all 0.5s;"></span>
                    </div>
                    <div>
                        <h5 class="card-title mb-0">Micrófono</h5>
                        <small class="text-muted" id="mic-status-text">Desactivado</small>
                    </div>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="mic-toggle"
                        style="width: 3em; height: 1.5em; cursor: pointer;">
                </div>
            </div>
        </div>
    </div>

    <!-- System Info Widget -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header border-0 bg-transparent">
                <i class="fas fa-server me-2 text-muted"></i> Info Sistema
            </div>
            <div class="card-body pt-0 d-flex justify-content-between align-items-center">
                <div>
                    <span class="d-block text-muted small">Estado</span>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="text-end">
                    <span class="d-block text-muted small">Versión</span>
                    <span class="fw-mono">v3.0.0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Mic Pulse Animation */
    @keyframes pulse-ring {
        0% {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0.5;
        }

        100% {
            transform: translate(-50%, -50%) scale(1.5);
            opacity: 0;
        }
    }

    .pulsing {
        animation: pulse-ring 1.5s infinite;
        border-color: var(--primary) !important;
        border-width: 2px;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    const micToggle = document.getElementById('mic-toggle');
    const micIcon = document.getElementById('mic-icon');
    const micIconBg = document.getElementById('mic-icon-bg');
    const micStatusText = document.getElementById('mic-status-text');
    const micPulse = document.getElementById('mic-pulse');
    const micCard = document.getElementById('mic-card');

    function updateMicUI(start_enabled) {
        if (start_enabled) {
            micToggle.checked = true;
            micIcon.className = 'fas fa-microphone fa-2x text-success';
            micIconBg.className = 'rounded-circle bg-success bg-opacity-10 p-3 me-3 position-relative';
            micStatusText.innerText = 'Escuchando...';
            micPulse.classList.add('pulsing');
            micCard.classList.add('border-primary');
        } else {
            micToggle.checked = false;
            micIcon.className = 'fas fa-microphone-slash fa-2x text-danger';
            micIconBg.className = 'rounded-circle bg-danger bg-opacity-10 p-3 me-3 position-relative';
            micStatusText.innerText = 'Silenciado';
            micPulse.classList.remove('pulsing');
            micCard.classList.remove('border-primary');
        }
    }

    // Initial Status Check
    fetch('/api/audio/status')
        .then(res => res.json())
        .then(data => {
            updateMicUI(data.input);
        });

    // Toggle Handler
    micToggle.addEventListener('change', function () {
        fetch('/api/audio/toggle', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                const newState = !data.muted;
                updateMicUI(newState);

                // Use new notify system
                if (newState) {
                    window.notify("Micrófono Activo", "El sistema ahora te está escuchando.", "success");
                } else {
                    window.notify("Micrófono Silenciado", "El sistema ha dejado de escuchar.", "warning");
                }
            });
    });

    // SocketIO Event
    if (typeof socket !== 'undefined') {
        socket.on('audio_status', function (data) {
            updateMicUI(data.input);
        });
    }

    // Stats Update
    function updateStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('cpu-temp').innerText = data.cpu_temp;
                document.getElementById('cpu-usage').innerText = data.cpu_usage;
                document.getElementById('ram-usage').innerText = data.ram_usage;
                document.getElementById('disk-usage').innerText = data.disk_usage;
            })
            .catch(err => console.error('Error fetching stats:', err));
    }

    // Initial call and interval
    updateStats();
    setInterval(updateStats, 2000);

    // --- Drag and Drop Persistence ---
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('dashboard-grid');

        // Load Order
        const savedOrder = localStorage.getItem('dashboard-order');
        if (savedOrder) {
            const order = JSON.parse(savedOrder);
            order.forEach(id => {
                const el = grid.querySelector(`[data-id="${id}"]`);
                if (el) grid.appendChild(el);
            });
        }

        // Init Sortable
        new Sortable(grid, {
            animation: 150,
            handle: '.move-handle',
            ghostClass: 'bg-primary',
            onEnd: function (evt) {
                const order = Array.from(grid.children).map(el => el.getAttribute('data-id'));
                localStorage.setItem('dashboard-order', JSON.stringify(order));
                window.notify("Diseño Guardado", "La disposición de los widgets se ha guardado.", "info");
            }
        });
    });
</script>
{% endblock %}