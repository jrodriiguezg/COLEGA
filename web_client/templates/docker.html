{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Docker Containers</h3>
        <button onclick="updateContainers()" class="btn-sm" style="float: right;">Refresh</button>
    </div>
    <div class="card-body">
        <table class="docker-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; border-bottom: 1px solid var(--border-color);">
                    <th style="padding: 10px;">Name</th>
                    <th style="padding: 10px;">Image</th>
                    <th style="padding: 10px;">Status</th>
                    <th style="padding: 10px;">Actions</th>
                </tr>
            </thead>
            <tbody id="containers-list">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Logs Modal -->
<div id="logs-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000;">
    <div class="modal-content" style="background:var(--bg-color); margin:5% auto; padding:20px; width:80%; max-height:80%; border-radius:5px; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Container Logs</h3>
            <button onclick="document.getElementById('logs-modal').style.display='none'" class="btn-sm">Close</button>
        </div>
        <pre id="logs-content" style="background:#1e1e1e; color:#0f0; padding:10px; border-radius:3px; overflow-x:auto; min-height:300px; white-space: pre-wrap; font-family: monospace;"></pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateContainers() {
        const tbody = document.getElementById('containers-list');
        tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
        
        fetch('/api/docker/containers')
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No containers found (or Docker not running).</td></tr>';
                    return;
                }
                
                data.forEach(c => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--border-color)';

                    const isUp = c.Status && c.Status.startsWith('Up');
                    const statusColor = isUp ? 'var(--success-color)' : 'var(--danger-color)';

                    row.innerHTML = `
                        <td style="padding: 15px 10px; font-weight: 500;">
                            ${c.Names} <br>
                            <span style="font-size:0.8em; color:var(--text-secondary);">${c.ID.substring(0,12)}</span>
                        </td>
                        <td style="padding: 15px 10px; font-size: 0.9em;">${c.Image}</td>
                        <td style="padding: 15px 10px;">
                            <span style="color: ${statusColor}; font-weight: bold; font-size: 0.8rem;">
                                ${c.Status}
                            </span>
                        </td>
                        <td style="padding: 15px 10px;">
                            <button onclick="controlContainer('${c.Names}', 'start')" class="btn-sm">Start</button>
                            <button onclick="controlContainer('${c.Names}', 'restart')" class="btn-sm">Restart</button>
                            <button onclick="controlContainer('${c.Names}', 'stop')" class="btn-sm btn-danger-sm">Stop</button>
                            <button onclick="showLogs('${c.Names}')" class="btn-sm info">Logs</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => {
                 tbody.innerHTML = '<tr><td colspan="4">Error loading containers.</td></tr>';
                 console.error(err);
            });
    }

    function controlContainer(id, action) {
        if (!confirm(`Are you sure you want to ${action} ${id}?`)) return;

        fetch('/api/docker/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, action: action })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // alert('Success: ' + data.message);
                } else {
                    alert('Error: ' + data.message);
                }
                // Wait a bit for status to update
                setTimeout(updateContainers, 1000);
            });
    }

    function showLogs(id) {
        document.getElementById('logs-modal').style.display = 'block';
        document.getElementById('logs-content').textContent = "Loading logs...";
        
        fetch('/api/docker/logs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, lines: 200 })
        })
            .then(res => res.json())
            .then(data => {
                 document.getElementById('logs-content').textContent = data.logs;
            });
    }

    updateContainers();
    
    // Auto refresh every 10s
    // setInterval(updateContainers, 10000);
</script>

<style>
    .btn-sm {
        padding: 4px 8px;
        font-size: 0.8rem;
        margin-right: 5px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-primary);
        cursor: pointer;
        border-radius: 3px;
    }

    .btn-sm:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    .btn-sm.info {
        border-color: #3498db;
        color: #3498db;
    }
    .btn-sm.info:hover {
        background: #3498db;
        color: white;
    }

    .btn-danger-sm {
        color: var(--danger-color);
        border-color: var(--danger-color);
    }

    .btn-danger-sm:hover {
        background: var(--danger-color);
        color: white;
    }
</style>
{% endblock %}
