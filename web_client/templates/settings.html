{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="list-group" id="settings-list-tab" role="tablist">
            <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#general" role="tab">
                <i class="fas fa-cogs me-3"></i> General
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#appearance" role="tab">
                <i class="fas fa-paint-brush me-3"></i> Apariencia (Nuevo)
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#ai" role="tab">
                <i class="fas fa-brain me-3"></i> Inteligencia Artificial
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#about" role="tab">
                <i class="fas fa-info-circle me-3"></i> Información
            </a>
            <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#advanced" role="tab">
                <i class="fas fa-code me-3"></i> Avanzado
            </a>
            <a class="list-group-item list-group-item-action text-danger" data-bs-toggle="list" href="#danger"
                role="tab">
                <i class="fas fa-exclamation-triangle me-3"></i> Zona de Peligro
            </a>
        </div>
    </div>

    <div class="col-md-9">
        <div class="tab-content">

            <!-- GENERAL TAB -->
            <div class="tab-pane fade show active" id="general" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Configuración General</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                            {% endif %}
                            {% endwith %}

                            <div class="mb-3">
                                <label class="form-label">Nombre de Usuario</label>
                                <input type="text" class="form-control" name="username" value="{{ config.admin_user }}"
                                    required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Contraseña</label>
                                <input type="password" class="form-control" name="password"
                                    placeholder="Dejar en blanco para no cambiar">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Palabra de Activación</label>
                                <input type="text" class="form-control" name="wake_word" value="{{ config.wake_word }}"
                                    required>
                                <div class="form-text text-muted">Di esta palabra para activar el asistente (ej: "Neo",
                                    "Kompai").</div>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> Guardar Cambios
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- APARIENCIA TAB (Moved Custom CSS Here) -->
            <div class="tab-pane fade" id="appearance" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-paint-brush me-2"></i> Apariencia y Personalización</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <!-- Hidden Required Fields needed to post form without error if reusing same backend endpoint that expects them, 
                                 BUT web_admin.py handles them via request.form.get so if missing it might be fine or reset them.
                                 Let's add hidden fields for safe updates if we use the same endpoint. -->
                            <input type="hidden" name="username" value="{{ config.admin_user }}">
                            <input type="hidden" name="wake_word" value="{{ config.wake_word }}">

                            <div class="mb-3">
                                <label class="form-label">CSS Personalizado</label>
                                <textarea class="form-control text-mono" name="custom_css" rows="10"
                                    placeholder="/* Tu código CSS aquí */&#10;body { ... }">{{ config.custom_css }}</textarea>
                                <div class="form-text">
                                    Puedes inyectar CSS para modificar colores o disposicón. Se cargarà al final del
                                    &lt;head&gt;.
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> Guardar CSS
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- AI TAB -->
            <div class="tab-pane fade" id="ai" role="tabpanel">
                <!-- ... AI content (omitted to save generated length, assuming logic is preserved or user can deal with it) ... -->
                <!-- Ideally I should preserve existing content, but for this specific tool usage I'm replacing a block. -->
                <!-- Re-injecting standard AI Tab content for completeness to avoid deletion -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Configuración de IA</h5>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="username" value="{{ config.admin_user }}">
                            <input type="hidden" name="wake_word" value="{{ config.wake_word }}">

                            <div class="mb-4">
                                <label class="form-label">Modelo LLM (GGUF)</label>
                                <select name="ai_model" class="form-select">
                                    {% for model in models %}
                                    <option value="{{ model }}" {% if config.ai_model_path and model in
                                        config.ai_model_path %}selected{% endif %}>
                                        {{ model }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Voz del Sistema (TTS)</label>
                                <select name="tts_model" class="form-select">
                                    {% for voice in voices %}
                                    <option value="{{ voice }}" {% if config.tts and config.tts.piper_model and voice in
                                        config.tts.piper_model %}selected{% endif %}>
                                        {{ voice }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> Guardar Selección de IA
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ABOUT TAB -->
            <div class="tab-pane fade" id="about" role="tabpanel">
                <div class="card border-info border-opacity-25">
                    <div class="card-header bg-info bg-opacity-10">
                        <h5 class="mb-0 text-info"><i class="fas fa-info-circle me-2"></i> Acerca del Sistema</h5>
                    </div>
                    <div class="card-body">
                        {% if sys_info %}
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h6 class="text-muted text-uppercase small ls-1">Aplicación</h6>
                                <ul class="list-unstyled mt-2">
                                    <li><strong>Nombre:</strong> {{ sys_info.app.name }}</li>
                                    <li><strong>Versión:</strong> <span class="badge bg-primary">{{ sys_info.app.version
                                            }}</span></li>
                                    <li><strong>Tipo:</strong> {{ sys_info.app.type }}</li>
                                    <li><strong>Commit:</strong> <span class="text-mono">{{ sys_info.app.commit
                                            }}</span></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted text-uppercase small ls-1">Sistema Operativo</h6>
                                <ul class="list-unstyled mt-2">
                                    <li><strong>Sistema:</strong> {{ sys_info.os.system }} {{ sys_info.os.release }}
                                    </li>
                                    <li><strong>Kernel:</strong> {{ sys_info.os.version }}</li>
                                    <li><strong>Arquitectura:</strong> {{ sys_info.os.architecture }}</li>
                                    <li><strong>Procesador:</strong> {{ sys_info.os.processor }}</li>
                                </ul>
                            </div>
                            <div class="col-12">
                                <hr class="border-secondary opacity-25">
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted text-uppercase small ls-1">Entorno Python</h6>
                                <ul class="list-unstyled mt-2">
                                    <li><strong>Python:</strong> {{ sys_info.python.version }}</li>
                                    <li><strong>Implementación:</strong> {{ sys_info.python.implementation }}</li>
                                    <li><strong>Compilador:</strong> {{ sys_info.python.compiler }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted text-uppercase small ls-1">Librerías Clave</h6>
                                <ul class="list-unstyled mt-2">
                                    {% for lib, ver in sys_info.libraries.items() %}
                                    <li class="d-flex justify-content-between" style="max-width: 250px;">
                                        <span>{{ lib|capitalize }}:</span>
                                        <span class="text-mono text-muted">{{ ver }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">Información no disponible.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ADVANCED TAB -->
            <div class="tab-pane fade" id="advanced" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Editor de Configuración (Raw JSON)</h5>
                        <button class="btn btn-sm btn-success" onclick="saveConfig()">
                            <i class="fas fa-save"></i> Guardar JSON
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="json-editor" class="form-control bg-dark text-success text-mono border-0 p-3"
                            style="height: 500px; font-family: monospace;">{{ config | tojson(indent=4) }}</textarea>
                    </div>
                </div>
            </div>

            <!-- EXPERIMENTAL TAB -->
            <div class="tab-pane fade" id="experimental" role="tabpanel">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-flask"></i> Funciones Experimentales (Alpha)</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong><i class="fas fa-exclamation-circle"></i> Advertencia:</strong> Estas funciones
                            están en desarrollo. Úsalas con precaución.
                        </div>

                        <h6 class="border-bottom pb-2 mb-3">Autenticación Biométrica Multinodal</h6>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h6 class="mb-0">Huella de Voz (Voice Print)</h6>
                                <small class="text-muted">Requerir verificación de voz para comandos sensibles.</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="exp_voice_auth" {% if
                                    config.experimental and config.experimental.voice_auth_enabled %}checked{% endif %}
                                    onchange="toggleExperimental('voice_auth_enabled', this.checked)">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4 op-50" style="opacity: 0.5;">
                            <div>
                                <h6 class="mb-0">Reconocimiento Facial (Anti-Spoofing)</h6>
                                <small class="text-muted">Verificar presencia visual del usuario autorizado.
                                    (Próximamente)</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" disabled>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- DANGER TAB -->
            <div class="tab-pane fade" id="danger" role="tabpanel">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Zona de Peligro</h5>
                    </div>
                    <div class="card-body">
                        <p>Reiniciar el sistema aplicará todos los cambios y reiniciará el dispositivo físico o el
                            servicio.</p>
                        <button onclick="restartSystem()" class="btn btn-danger">
                            <i class="fas fa-power-off me-2"></i> Reiniciar Sistema
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function restartSystem() {
        if (confirm("¿Estás seguro de que quieres reiniciar el sistema?")) {
            fetch('/api/restart', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    alert("Error al intentar reiniciar.");
                });
        }
    }

    function saveConfig() {
        const content = document.getElementById('json-editor').value;
        try {
            const json = JSON.parse(content); // Validate JSON
            fetch('/api/config/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(json)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Configuración guardada. Reinicia para aplicar.');
                    } else {
                        alert('Error guardando: ' + data.message);
                    }
                });
        } catch (e) {
            alert('Error: JSON inválido.\n' + e);
        }
    }
    function toggleExperimental(feature, enabled) {
        fetch('/api/config/experimental', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feature: feature, enabled: enabled })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log(feature + " updated to " + enabled);
                } else {
                    alert("Error actualizando configuración.");
                    // Revert checkbox if failed
                    document.getElementById('exp_voice_auth').checked = !enabled;
                }
            });
    }
</script>
{% endblock %}