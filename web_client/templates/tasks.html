{% extends "base.html" %}

{% block content %}
<div class="row fade-in">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>Scheduled Tasks (Cron)</h3>
                <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                    <i class="fas fa-plus"></i> New Task
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Next Run</th>
                                <th>Cron Expression</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-list">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Schedule New Command</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Task Name</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="taskName"
                        placeholder="e.g. Restart Router">
                </div>
                <div class="mb-3">
                    <label class="form-label">Bash Command</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="taskCommand"
                        placeholder="e.g. reboot">
                    <div class="form-text text-muted">Use with caution. Runs as user 'neo'.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Cron Expression</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="taskCron"
                        placeholder="min hour day month dow">
                    <div class="form-text text-muted">Format: <code>* * * * *</code> (Minute Hour Day Month DayOfWeek)
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="setCron('0 3 * * *')">Daily
                            3AM</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setCron('0 0 * * 0')">Weekly
                            (Sun)</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="setCron('*/5 * * * *')">Every 5
                            mins</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTask()">Schedule</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function loadTasks() {
        const tbody = document.getElementById('tasks-list');
        tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

        fetch('/api/tasks/list')
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No scheduled tasks.</td></tr>';
                    return;
                }

                data.forEach(job => {
                    const row = `
                        <tr>
                            <td><strong>${job.name}</strong></td>
                            <td>${job.next_run}</td>
                            <td><code style="color:var(--accent-color)">${job.trigger}</code></td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteTask('${job.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function showAddTaskModal() {
        new bootstrap.Modal(document.getElementById('addTaskModal')).show();
    }

    function setCron(val) {
        document.getElementById('taskCron').value = val;
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        const command = document.getElementById('taskCommand').value;
        const cron = document.getElementById('taskCron').value;

        if (!name || !command || !cron) {
            alert("All fields are required");
            return;
        }

        fetch('/api/tasks/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, command, cron })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
                    loadTasks();
                } else {
                    alert("Error: " + data.message);
                }
            });
    }

    function deleteTask(id) {
        if (confirm("Delete this task?")) {
            fetch('/api/tasks/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) loadTasks();
                    else alert(data.message);
                });
        }
    }

    document.addEventListener('DOMContentLoaded', loadTasks);
</script>
{% endblock %}